--- a/src/nvim/CMakeLists.txt	2023-03-16 17:41:00.000000000 -0700
+++ b/src/nvim/CMakeLists.txt	2023-03-17 05:21:01.924669000 -0700
@@ -463,7 +463,7 @@
   add_custom_command(
     OUTPUT "${gf_c_h}" "${gf_h_h}"
     COMMAND ${CMAKE_C_COMPILER} ${sfile} ${PREPROC_OUTPUT} ${gen_cflags}
-    COMMAND "${LUA_PRG}" "${HEADER_GENERATOR}" "${sfile}" "${gf_c_h}" "${gf_h_h}" "${gf_i}"
+    COMMAND "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" "${LUA_PRG}" "${HEADER_GENERATOR}" "${sfile}" "${gf_c_h}" "${gf_h_h}" "${gf_i}"
     DEPENDS ${depends})
   list(APPEND NVIM_GENERATED_FOR_SOURCES "${gf_c_h}")
   list(APPEND NVIM_GENERATED_FOR_HEADERS "${gf_h_h}")
@@ -473,7 +473,7 @@
 endforeach()
 
 add_custom_command(OUTPUT ${GENERATED_UNICODE_TABLES}
-  COMMAND ${LUA_PRG} ${UNICODE_TABLES_GENERATOR}
+  COMMAND "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" ${LUA_PRG} ${UNICODE_TABLES_GENERATOR}
                      ${UNICODE_DIR}
                      ${GENERATED_UNICODE_TABLES}
   DEPENDS
@@ -484,7 +484,7 @@
 add_custom_command(
   OUTPUT ${GENERATED_API_DISPATCH} ${GENERATED_FUNCS_METADATA}
          ${API_METADATA} ${LUA_API_C_BINDINGS}
-  COMMAND ${LUA_GEN_PRG} ${API_DISPATCH_GENERATOR} ${CMAKE_CURRENT_LIST_DIR}
+  COMMAND "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" ${LUA_GEN_PRG} ${API_DISPATCH_GENERATOR} ${CMAKE_CURRENT_LIST_DIR}
                          ${GENERATED_API_DISPATCH}
                          ${GENERATED_FUNCS_METADATA} ${API_METADATA}
                          ${LUA_API_C_BINDINGS}
@@ -500,8 +500,8 @@
 add_custom_command(
   OUTPUT ${VIM_MODULE_FILE}
   COMMAND ${CMAKE_COMMAND} -E env
-      "LUAC_PRG=${LUAC_PRG}"
-      ${LUA_PRG} ${CHAR_BLOB_GENERATOR} -c ${VIM_MODULE_FILE}
+      "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" "LUAC_PRG=${LUAC_PRG}"
+      "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" ${LUA_PRG} ${CHAR_BLOB_GENERATOR} -c ${VIM_MODULE_FILE}
       ${LUA_INIT_PACKAGES_MODULE_SOURCE} "vim._init_packages"
       ${LUA_INSPECT_MODULE_SOURCE} "vim.inspect"
       ${LUA_EDITOR_MODULE_SOURCE} "vim._editor"
@@ -533,7 +533,7 @@
          ${GENERATED_UI_EVENTS_REMOTE}
          ${GENERATED_UI_EVENTS_METADATA}
          ${GENERATED_UI_EVENTS_CLIENT}
-  COMMAND ${LUA_GEN_PRG} ${API_UI_EVENTS_GENERATOR} ${CMAKE_CURRENT_LIST_DIR}
+  COMMAND "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" ${LUA_GEN_PRG} ${API_UI_EVENTS_GENERATOR} ${CMAKE_CURRENT_LIST_DIR}
                          ${CMAKE_CURRENT_LIST_DIR}/api/ui_events.in.h
                          ${GENERATED_UI_EVENTS_CALL}
                          ${GENERATED_UI_EVENTS_REMOTE}
@@ -566,13 +566,13 @@
 )
 
 add_custom_command(OUTPUT ${GENERATED_EX_CMDS_ENUM} ${GENERATED_EX_CMDS_DEFS}
-  COMMAND ${LUA_PRG} ${EX_CMDS_GENERATOR}
+  COMMAND "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" ${LUA_PRG} ${EX_CMDS_GENERATOR}
       ${CMAKE_CURRENT_LIST_DIR} ${GENERATED_INCLUDES_DIR} ${GENERATED_DIR}
   DEPENDS ${EX_CMDS_GENERATOR} ${CMAKE_CURRENT_LIST_DIR}/ex_cmds.lua
 )
 
 add_custom_command(OUTPUT ${GENERATED_FUNCS} ${FUNCS_DATA}
-  COMMAND ${LUA_PRG} ${FUNCS_GENERATOR}
+  COMMAND "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" ${LUA_PRG} ${FUNCS_GENERATOR}
       ${CMAKE_CURRENT_LIST_DIR} ${LUA_SHARED_MODULE_SOURCE} ${GENERATED_DIR} ${API_METADATA} ${FUNCS_DATA}
   DEPENDS ${FUNCS_GENERATOR} ${CMAKE_CURRENT_LIST_DIR}/eval.lua ${API_METADATA}
 )
@@ -580,19 +580,19 @@
   "${GENERATED_FUNCS}")
 
 add_custom_command(OUTPUT ${GENERATED_EVENTS_ENUM} ${GENERATED_EVENTS_NAMES_MAP}
-  COMMAND ${LUA_PRG} ${EVENTS_GENERATOR}
+  COMMAND "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" ${LUA_PRG} ${EVENTS_GENERATOR}
       ${CMAKE_CURRENT_LIST_DIR} ${GENERATED_EVENTS_ENUM} ${GENERATED_EVENTS_NAMES_MAP}
   DEPENDS ${EVENTS_GENERATOR} ${CMAKE_CURRENT_LIST_DIR}/auevents.lua
 )
 
 add_custom_command(OUTPUT ${GENERATED_KEYSETS} ${GENERATED_KEYSETS_DEFS}
-  COMMAND ${LUA_PRG} ${KEYSETS_GENERATOR}
+  COMMAND "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" ${LUA_PRG} ${KEYSETS_GENERATOR}
       ${CMAKE_CURRENT_LIST_DIR} ${LUA_SHARED_MODULE_SOURCE} ${GENERATED_KEYSETS} ${GENERATED_KEYSETS_DEFS}
   DEPENDS ${KEYSETS_GENERATOR} ${CMAKE_CURRENT_LIST_DIR}/api/keysets.lua ${GENERATOR_HASHY}
 )
 
 add_custom_command(OUTPUT ${GENERATED_OPTIONS}
-  COMMAND ${LUA_PRG} ${OPTIONS_GENERATOR}
+  COMMAND "DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}" "LUA_CPATH=$ENV{LUA_CPATH}" ${LUA_PRG} ${OPTIONS_GENERATOR}
                      ${CMAKE_CURRENT_LIST_DIR} ${GENERATED_OPTIONS}
   DEPENDS ${OPTIONS_GENERATOR} ${CMAKE_CURRENT_LIST_DIR}/options.lua
 )
